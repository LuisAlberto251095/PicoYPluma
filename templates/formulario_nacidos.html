<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de {{ etapa|capitalize }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #f4f6f9; font-family: 'Poppins', sans-serif; }
        .container { max-width: 800px; margin: 40px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }

        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; color: #555; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        input:focus, select:focus { border-color: #3498db; outline: none; }

        .hidden { display: none; }
        input[readonly] { background-color: #e9ecef; color: #495057; font-weight: bold; border-color: #ced4da; cursor: not-allowed; }

        .btn-submit { background-color: #2ecc71; color: white; border: none; padding: 15px; width: 100%; font-size: 1.1rem; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 20px; }
        .btn-submit:hover { background-color: #27ae60; }

        .info-row { display: flex; gap: 20px; }
        .info-col { flex: 1; }

        .edad-display { background: #e8f6f3; color: #16a085; padding: 10px; border-radius: 8px; font-weight: bold; text-align: center; margin-top: 5px; }

        .flash-msg { padding: 15px; background: #e74c3c; color: white; border-radius: 8px; margin-bottom: 20px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="flash-msg">{{ messages[0] }}</div>
        {% endif %}
    {% endwith %}

    <h1>Registro de Aves: <span style="color: #3498db;">{{ etapa|capitalize }}</span></h1>

    <form action="{{ url_for('formulario_final_ave', etapa=etapa) }}" method="POST">

        <div class="info-row">
            <div class="info-col">
                <label>Fecha de Nacimiento</label>
                <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" required onchange="calcularEdad()">
            </div>
            <div class="info-col">
                <label>Edad Actual</label>
                <div id="edad_display" class="edad-display">Seleccione fecha</div>
            </div>
        </div>

        <div class="info-row" style="margin-top: 20px;">
            <div class="info-col">
                <label>Tipo de Ave</label>
                <select id="tipo_ave" name="tipo_ave" onchange="actualizarDescripcion()" required>
                    <option value="" disabled selected>-- Seleccione --</option>
                </select>
                <input type="text" id="nuevo_tipo_ave" name="nuevo_tipo_ave" class="hidden" placeholder="Escriba el nuevo tipo de ave" style="margin-top: 10px;">
            </div>
            <div class="info-col">
                <label>Descripción / Color</label>
                <select id="descripcion" name="descripcion" onchange="verificarNuevaDescripcion()" required>
                    <option value="" disabled selected>-- Primero elija ave --</option>
                </select>
                <input type="text" id="nueva_descripcion" name="nueva_descripcion" class="hidden" placeholder="Escriba la nueva descripción" style="margin-top: 10px;">
            </div>
        </div>

        <div class="info-row" style="margin-top: 20px;">
            <div class="info-col">
                <label>ID Único (Lote o Anillo)</label>
                <input type="text" name="lote_codigo" placeholder="Ej: AV-2024-001" required>
            </div>
            <div class="info-col">
                <label>Cantidad de Aves</label>
                <input type="number" id="input_cantidad" name="cantidad" value="1" min="1" required oninput="calcularTotal()">
            </div>
        </div>

        <h3 style="margin-top: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px;">Datos Financieros</h3>

        <div class="form-group">
            <label>Forma de Pago</label>
            <select id="forma_pago" name="forma_pago" onchange="actualizarPago()" required>
                <option value="Efectivo">Efectivo</option>
                <option value="Deposito">Depósito / Transferencia</option>
            </select>
        </div>

        <div class="info-row">
            <div class="info-col">
                <label>Valor Unitario ($)</label>
                <input type="number" step="0.01" id="costo_unitario" name="costo_unitario" placeholder="0.00" required oninput="calcularTotal()">
            </div>
            <div class="info-col">
                <label>Valor Total ($)</label>
                <input type="number" step="0.01" id="valor_total" name="valor_total" placeholder="0.00" readonly>
            </div>
        </div>

        <div class="form-group hidden" id="div_comprobante" style="margin-top: 15px;">
            <label>Número de Comprobante</label>
            <input type="text" name="numero_comprobante" placeholder="Ej: 123456789">
        </div>

        <button type="submit" class="btn-submit">Guardar Registro</button>
        <a href="{{ url_for('formulario_compra', categoria='aves') }}" style="display:block; text-align:center; margin-top:15px; text-decoration:none; color:#777;">Cancelar</a>
    </form>
</div>

<script>
    // CATALOGO Y DROPDOWNS
    const catalogoAves = {
        "Brahmas": ["Porcelanas", "BSO", "Splash", "Armiñado", "Azules", "Moteados", "Buff"],
        "Gallinas de Guinea": ["Blancas", "Pecho blanco", "Lavanda", "Azules", "Perlada"],
        "Patos": ["Criollos"],
        "Pavos": ["Criollos", "Ornamentales"],
        "Silkies": ["Negros", "Blancos", "Buff", "Paint"]
    };

    const selectAve = document.getElementById("tipo_ave");
    const avesOrdenadas = Object.keys(catalogoAves).sort();

    avesOrdenadas.forEach(ave => {
        let option = document.createElement("option");
        option.value = ave;
        option.text = ave;
        selectAve.appendChild(option);
    });

    let optionNew = document.createElement("option");
    optionNew.value = "Otro";
    optionNew.text = "➕ Crear Nuevo Tipo...";
    optionNew.style.fontWeight = "bold";
    optionNew.style.color = "#2980b9";
    selectAve.appendChild(optionNew);

    function actualizarDescripcion() {
        const tipo = document.getElementById("tipo_ave").value;
        const selectDesc = document.getElementById("descripcion");
        const inputNuevoTipo = document.getElementById("nuevo_tipo_ave");
        const inputNuevaDesc = document.getElementById("nueva_descripcion");

        selectDesc.innerHTML = '<option value="" disabled selected>-- Seleccione --</option>';
        inputNuevoTipo.classList.add("hidden");
        inputNuevaDesc.classList.add("hidden");

        if (tipo === "Otro") {
            inputNuevoTipo.classList.remove("hidden");
            let opt = document.createElement("option");
            opt.value = "Otro";
            opt.text = "Ingresar Manualmente";
            opt.selected = true;
            selectDesc.appendChild(opt);
            inputNuevaDesc.classList.remove("hidden");
        } else if (catalogoAves[tipo]) {
            catalogoAves[tipo].forEach(desc => {
                let opt = document.createElement("option");
                opt.value = desc;
                opt.text = desc;
                selectDesc.appendChild(opt);
            });
            let optNew = document.createElement("option");
            optNew.value = "Otro";
            optNew.text = "➕ Crear Nueva Descripción...";
            optNew.style.fontWeight = "bold";
            optNew.style.color = "#2980b9";
            selectDesc.appendChild(optNew);
        }
    }

    function verificarNuevaDescripcion() {
        const val = document.getElementById("descripcion").value;
        const input = document.getElementById("nueva_descripcion");
        if (val === "Otro") {
            input.classList.remove("hidden");
            input.required = true;
            input.focus();
        } else {
            input.classList.add("hidden");
            input.required = false;
        }
    }

    // CALCULO DE EDAD
    function calcularEdad() {
        const fechaInput = document.getElementById("fecha_nacimiento").value;
        if (fechaInput) {
            const nacimiento = new Date(fechaInput);
            const hoy = new Date();
            const diferencia = hoy - nacimiento;
            const dias = Math.floor(diferencia / (1000 * 60 * 60 * 24));

            let texto = "";
            if (dias < 0) texto = "Fecha futura no válida";
            else if (dias === 0) texto = "Nacido hoy (0 días)";
            else if (dias < 30) texto = dias + " días";
            else {
                const meses = Math.floor(dias / 30);
                const diasRestantes = dias % 30;
                texto = meses + " meses y " + diasRestantes + " días";
            }
            document.getElementById("edad_display").innerText = texto;
        }
    }

    // CALCULO TOTAL $$$
    function calcularTotal() {
        const cantidad = parseFloat(document.getElementById("input_cantidad").value) || 0;
        const unitario = parseFloat(document.getElementById("costo_unitario").value) || 0;
        const total = cantidad * unitario;
        document.getElementById("valor_total").value = total.toFixed(2);
    }

    function actualizarPago() {
        const pago = document.getElementById("forma_pago").value;
        const divComp = document.getElementById("div_comprobante");
        if (pago === "Deposito") {
            divComp.classList.remove("hidden");
            document.getElementsByName("numero_comprobante")[0].required = true;
        } else {
            divComp.classList.add("hidden");
            document.getElementsByName("numero_comprobante")[0].required = false;
        }
    }
</script>

</body>
</html>